<!DOCTYPE html>
<html>
  <head>
    <title>Sapna Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              clifford: "#da373d",
            },
          },
        },
      };
    </script>
  </head>
  <body>
    <div class="max-w-md mx-auto">
      <h1 class="text-2xl font-semibold mb-6">Payment Details</h1>
      <form method="post" id="details">
        <div class="mb-4">
          <label for="name" class="block text-sm font-medium mb-2">
            Name
          </label>
          <input
            id="name"
            name="name"
            class="bg-white border border-[#d1d5db] text-[#111827] sm:text-sm rounded-lg block w-full p-2.5"
            placeholder="Enter Name"
            type="text"
          />
          <p id="nameError" class="hidden text-red-500 text-xs m-1">
            Please enter your name.
          </p>
        </div>
        <div class="mb-4">
          <label for="email" class="block text-sm font-medium mb-2">
            Email
          </label>
          <input
            id="email"
            name="email"
            class="bg-white border border-[#d1d5db] text-[#111827] sm:text-sm rounded-lg block w-full p-2.5"
            placeholder="Enter Email"
            type="text"
          />
          <p id="emailError" class="hidden text-red-500 text-xs m-1">
            Please enter a valid email address.
          </p>
        </div>
        <div class="mb-4">
          <label for="phone" class="block text-sm font-medium mb-2">
            Phone
          </label>
          <div class="flex">
            <span
              class="inline-flex items-center px-3 text-sm text-gray-500 bg-gray-200 border border-r-0 border-[#d1d5db] rounded-l-md"
            >
              IND
            </span>
            <input
              id="phone"
              name="phone"
              class="bg-white border border-[#d1d5db] text-[#111827] sm:text-sm rounded-none rounded-r-lg block w-full p-2.5"
              placeholder="Enter Phone"
              type="text"
            />
          </div>
          <p id="phoneError" class="hidden text-red-500 text-xs m-1">
            Please enter valid 10 digit phone number.
          </p>
        </div>
        <div class="mb-4">
          <div class="flex justify-between mb-2">
            <span class="text-sm font-medium">Original Price</span>
            <span class="text-sm">₹199.00</span>
          </div>
          <hr />
          <div class="flex justify-between mt-2">
            <span class="text-sm font-semibold">Total</span>
            <span class="text-sm font-semibold">₹199.00</span>
          </div>
        </div>
        <button
          type="submit"
          id="payment"
          class="w-full bg-black text-white rounded-lg px-4 py-2.5 hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-50 cursor:pointer"
        >
          Pay ₹199.00
        </button>
      </form>
    </div>
    <script>
      const clientName = "ANKIT_TEST";
      const amount = "199";
      const purpose = "test";
      const redirectUrl = "https://google.com";
      const userDetailWebhook =
        "https://connect.pabbly.com/workflow/sendwebhookdata/IjU3NjUwNTZhMDYzNDA0M2M1MjY1NTUzZDUxMzci_pc";
      const paymentDetailWebhook =
        "https://connect.pabbly.com/workflow/sendwebhookdata/IjU3NjUwNTZhMDYzNDA0M2M1MjY1NTUzZDUxMzci_pc";
      const checkPaymentWebhook =
        "https://connect.pabbly.com/workflow/sendwebhookdata/IjU3NjUwNTZhMDYzNDA0M2M1MjY1NTUzZDUxMzci_pc";

      const form = document.getElementById("details");
      const paymentButton = document.getElementById("payment");

      const getInput = (name) => {
        return document.getElementById(name);
      };

      const setBorder = (input, value) => {
        input.style.border = value;
      };

      const isValidEmail = (email) => {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      };

      const isValidPhone = (phone) => {
        const phoneRegex = /^[0-9]{10}$/;
        return phoneRegex.test(phone);
      };

      paymentButton.addEventListener("click", async (e) => {
        e.preventDefault();

        const formData = {
          name: form.name.value.trim(),
          email: form.email.value.trim(),
          phone: form.phone.value.trim(),
        };

        let isValid = true;

        if (!formData.name) {
          const nameError = getInput("nameError");
          nameError.style.display = "flex";
          const input = getInput("name");
          input.oninput = function () {
            nameError.style.display = "none";
            setBorder(input, "");
          };
          setBorder(input, "1px solid red");
          isValid = false;
        }

        if (!isValidEmail(formData.email)) {
          const emailError = getInput("emailError");
          emailError.style.display = "flex";
          const input = getInput("email");
          input.oninput = function () {
            emailError.style.display = "none";
            setBorder(input, "");
          };
          setBorder(input, "1px solid red");
          isValid = false;
        }

        if (!isValidPhone(formData.phone)) {
          const phoneError = getInput("phoneError");
          phoneError.style.display = "flex";
          const input = getInput("phone");
          input.oninput = function () {
            phoneError.style.display = "none";
            setBorder(input, "");
          };
          setBorder(input, "1px solid red");
          isValid = false;
        }

        if (isValid) {
          paymentButton.style.opacity = 0.7;
          paymentButton.innerText = "Submitting...";
          const urlParams = new URLSearchParams(window.location.search);
          const data = {
            name: formData.name,
            amount,
            email: formData.email,
            phone: formData.phone,
            purpose,
            redirectUrl,
            utm_source: urlParams.get("utm_source"),
            utm_medium: urlParams.get("utm_medium"),
            utm_campaign: urlParams.get("utm_campaign"),
            utm_adgroup: urlParams.get("utm_adgroup"),
            utm_content: urlParams.get("utm_content"),
            utm_term: urlParams.get("utm_term"),
            utm_id: urlParams.get("utm_id"),
            adsetname: urlParams.get("adset name"),
            adname: urlParams.get("ad name"),
            landingPageSource: window.location.href,
          };

          const updatedData = {
            formData: data,
            userDetailWebhook,
            paymentDetailWebhook,
            checkPaymentWebhook,
          };

          try {
            const response = await fetch(
              `https://instamojopaymentsetup-test.onrender.com/api/payments/new/instamojo/createPayment/${clientName}`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(updatedData),
              }
            );
            const jsonData = await response.json();
            console.log(jsonData);
            paymentButton.style.opacity = 1;
            paymentButton.innerText = "Pay ₹199.00";
            window.location.href = jsonData.data;
          } catch (error) {
            alert("Some error occured! Please retry");
            console.log(error);
          }
        }
      });
    </script>
  </body>
</html>
